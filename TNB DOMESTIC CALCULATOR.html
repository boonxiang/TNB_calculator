<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TNB Electricity Bill Calculator</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #c7fbfd;
            color: #333;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: #fff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        h1, h2 {
            color: #0056b3;
            text-align: center;
        }
        .input-section, .output-section {
            margin-bottom: 20px;
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }
        input[type="number"], select {
            width: calc(100% - 20px);
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            transition: background-color 0.3s ease;
        }
        button:hover {
            background-color: #0056b3;
        }
        .result-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        .result-table th, .result-table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }
        .result-table th {
            background-color: #e2e2e2;
            font-weight: bold;
        }
        .error {
            color: red;
            font-weight: bold;
            text-align: center;
            margin-top: 10px;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>TNB Electricity Bill Calculator</h1>
        <p>This tool helps you estimate your TNB electricity bill based on your usage, or find your usage based on your bill amount.</p>

        <div class="input-section">
            <label for="calculationType">Choose Calculation Type:</label>
            <select id="calculationType" onchange="toggleSections()">
                <option value="calculate_bill_tou">Calculate Bill from Usage (kWh) - Time-of-Use (ToU)</option>
                <option value="estimate_usage_tou">Estimate Usage from Bill (RM) - Time-of-Use (ToU)</option>
                <option value="calculate_bill_general">Calculate Bill from Usage (kWh) - Domestic General Tariff</option>
                <option value="estimate_usage_general">Estimate Usage from Bill (RM) - Domestic General Tariff</option>
            </select>
        </div>

        <div id="calculateBillSection" class="input-section">
            <h2>Calculate Bill from Usage (Time-of-Use)</h2>
            <label for="totalUsage">Total Usage (kWh):</label>
            <input type="number" id="totalUsage" placeholder="e.g., 750">

            <label for="peakPercent">Peak Usage Percentage (%):</label>
            <input type="number" id="peakPercent" placeholder="e.g., 30" value="30">

            <button onclick="calculateBillTou()">Calculate Bill</button>
            <div id="calculateBillError" class="error"></div>
        </div>

        <div class="output-section hidden" id="billOutput">
            <h2>Estimated Bill Details (Time-of-Use)</h2>
            <table class="result-table">
                <tr><th>Description</th><th>Amount (RM)</th></tr>
                <tr><td>Total Usage (kWh)</td><td id="outputTotalUsage"></td></tr>
                <tr><td>Peak Usage (kWh)</td><td id="outputPeakUsageKWH"></td></tr>
                <tr><td>Off-Peak Usage (kWh)</td><td id="outputOffPeakUsageKWH"></td></tr>
                <tr><td>Peak Percentage (%)</td><td id="outputPeakPercent"></td></tr>
                <tr><td>Off-Peak Percentage (%)</td><td id="outputOffPeakPercent"></td></tr>
                <tr><td colspan="2"><hr></td></tr>
                <tr><td>Energy (Peak)</td><td id="outputEnergyPeakTotal"></td></tr>
                <tr><td>Energy (Off-Peak)</td><td id="outputEnergyOffPeakTotal"></td></tr>
                <tr><td>Capacity Charge</td><td id="outputCapacityTotal"></td></tr>
                <tr><td>Network Charge</td><td id="outputNetworkTotal"></td></tr>
                <tr><td>Retail Charge</td><td id="outputRetailTotal"></td></tr>
                <tr><td>EEI Rebate</td><td id="outputEEIRebate"></td></tr>
                <tr><td><strong>Subtotal Before Tax</strong></td><td id="outputSubtotalBeforeTax"></td></tr>
                <tr><td>Service Tax (8%)</td><td id="outputServiceTax"></td></tr>
                <tr><td>KWTBB (1.6%)</td><td id="outputKWTBB"></td></tr>
                <tr><td><strong>Total Bill</strong></td><td id="outputTotalBill"></td></tr>
            </table>
        </div>

        <div id="estimateUsageSection" class="input-section hidden">
            <h2>Estimate Usage from Bill (Time-of-Use)</h2>
            <label for="targetBill">Target Total Bill (RM):</label>
            <input type="number" id="targetBill" placeholder="e.g., 250">

            <label for="peakPercentReverse">Peak Usage Percentage (%):</label>
            <input type="number" id="peakPercentReverse" placeholder="e.g., 30" value="30">

            <button onclick="estimateUsageTou()">Estimate Usage</button>
            <div id="estimateUsageError" class="error"></div>
        </div>

        <div class="output-section hidden" id="usageOutput">
            <h2>Estimated Usage Details (Time-of-Use)</h2>
            <table class="result-table">
                <tr><th>Description</th><th>Amount</th></tr>
                <tr><td>Estimated Total Usage (kWh)</td><td id="outputEstimatedTotalKWH"></td></tr>
                <tr><td>Estimated Peak Usage (kWh)</td><td id="outputEstimatedPeakKWH"></td></tr>
                <tr><td>Estimated Off-Peak Usage (kWh)</td><td id="outputEstimatedOffPeakKWH"></td></tr>
                <tr><td>Peak Percentage (%)</td><td id="outputReversePeakPercent"></td></tr>
                <tr><td>Off-Peak Percentage (%)</td><td id="outputReverseOffPeakPercent"></td></tr>
                <tr><td>Matched Total Bill (RM)</td><td id="outputMatchedTotalBill"></td></tr>
                <tr><td colspan="2"><hr></td></tr>
                <tr><td>Service Tax (RM)</td><td id="outputReverseServiceTax"></td></tr>
                <tr><td>KWTBB (RM)</td><td id="outputReverseKWTBB"></td></tr>
                <tr><td>Retail Charge (RM)</td><td id="outputReverseRetailCharge"></td></tr>
                <tr><td>Network Charge (RM)</td><td id="outputReverseNetworkCharge"></td></tr>
                <tr><td>Capacity Charge (RM)</td><td id="outputReverseCapacityCharge"></td></tr>
                <tr><td>Energy (Peak) (RM)</td><td id="outputReverseEnergyPeakTotal"></td></tr>
                <tr><td>Energy (Off-Peak) (RM)</td><td id="outputReverseEnergyOffPeakTotal"></td></td></tr>
                <tr><td>EEI Rebate (RM)</td><td id="outputReverseEEIRebate"></td></tr>
                <tr><td>Subtotal Before Tax (RM)</td><td id="outputReverseSubtotalBeforeTax"></td></tr>
            </table>
            <p id="outputReverseStatus"></p>
        </div>

        <div id="generalTariffCalculateBillSection" class="input-section hidden">
            <h2>Calculate Bill from Usage (Domestic General Tariff)</h2>
            <label for="generalUsageInput">Total Usage (kWh):</label>
            <input type="number" id="generalUsageInput" placeholder="e.g., 1200">
            <button onclick="calculateGeneralBill()">Calculate Bill</button>
            <div id="generalCalculateBillError" class="error"></div>
        </div>

        <div class="output-section hidden" id="generalBillOutput">
            <h2>Estimated Bill Details (Domestic General Tariff)</h2>
            <table class="result-table">
                <tr><th>Description</th><th>Amount (RM)</th></tr>
                <tr><td>Total Usage (kWh)</td><td id="generalOutputTotalUsage"></td></tr>
                <tr><td colspan="2"><hr></td></tr>
                <tr><td>Energy Charge (Non-Taxable)</td><td id="generalOutputEnergyNT"></td></tr>
                <tr><td>Energy Charge (Taxable)</td><td id="generalOutputEnergyTax"></td></tr>
                <tr><td>Capacity Charge</td><td id="generalOutputCapacity"></td></tr>
                <tr><td>Network Charge</td><td id="generalOutputNetwork"></td></tr>
                <tr><td>Retail Charge</td><td id="generalOutputRetail"></td></tr>
                <tr><td>EEI Rebate</td><td id="generalOutputEEI"></td></tr>
                <tr><td><strong>Subtotal Before Tax</strong></td><td id="generalOutputSubtotal"></td></tr>
                <tr><td>Service Tax (8%)</td><td id="generalOutputServiceTax"></td></tr>
                <tr><td>KWTBB (1.6%)</td><td id="generalOutputKWTBB"></td></tr>
                <tr><td><strong>Total Bill</strong></td><td id="generalOutputTotalBill"></td></tr>
            </table>
        </div>

        <div id="generalTariffEstimateUsageSection" class="input-section hidden">
            <h2>Estimate Usage from Bill (RM) - Domestic General Tariff</h2>
            <label for="generalBillInput">Target Total Bill (RM):</label>
            <input type="number" id="generalBillInput" placeholder="e.g., 300">
            <button onclick="estimateGeneralUsage()">Estimate Usage</button>
            <div id="generalEstimateUsageError" class="error"></div>
        </div>

        <div class="output-section hidden" id="generalUsageOutput">
            <h2>Estimated Usage Details (Domestic General Tariff)</h2>
            <table class="result-table">
                <tr><th>Description</th><th>Amount</th></tr>
                <tr><td>Estimated Total Usage (kWh)</td><td id="generalOutputEstimatedTotalKWH"></td></tr>
                <tr><td>Matched Total Bill (RM)</td><td id="generalOutputMatchedTotalBill"></td></tr>
                <tr><td colspan="2"><hr></td></tr>
                <tr><td>Energy Charge (Non-Taxable)</td><td id="generalReverseEnergyNT"></td></tr>
                <tr><td>Energy Charge (Taxable)</td><td id="generalReverseEnergyTax"></td></tr>
                <tr><td>Capacity Charge</td><td id="generalReverseCapacity"></td></tr>
                <tr><td>Network Charge</td><td id="generalReverseNetwork"></td></tr>
                <tr><td>Retail Charge</td><td id="generalReverseRetail"></td></tr>
                <tr><td>EEI Rebate</td><td id="generalReverseEEI"></td></tr>
                <tr><td>Subtotal Before Tax (RM)</td><td id="generalReverseSubtotal"></td></tr>
                <tr><td>Service Tax (RM)</td><td id="generalReverseServiceTax"></td></tr>
                <tr><td>KWTBB (RM)</td><td id="generalReverseKWTBB"></td></tr>
            </table>
            <p id="generalReverseStatus"></p>
        </div>

    </div>

    <script>
        // TNB Time-of-Use Rates 
        const TNB_RATES_TOU = {
            'low': {  // ≤1500 kWh
                'peak': 0.2852,
                'off_peak': 0.2443,
                'capacity': 0.0455,
                'network': 0.1285,
                'retail': 10.00
            },
            'high': {  // >1500 kWh
                'peak': 0.3852,
                'off_peak': 0.3443,
                'capacity': 0.0455,
                'network': 0.1285,
                'retail': 10.00
            }
        };

        // TNB Domestic General Tariff Rates 
        const TNB_RATES_GENERAL = {
            low: { energy: 0.2703, capacity: 0.0455, network: 0.1285, retail: 10.00 },
            high: { energy: 0.3703, capacity: 0.0455, network: 0.1285, retail: 10.00 }
        };

        // EEI Rates (common to both, but functions are slightly different)
        const EEI_RATES_TOU = [
            {'min': 1, 'max': 200, 'rate': 0.25},
            {'min': 201, 'max': 250, 'rate': 0.245},
            {'min': 251, 'max': 300, 'rate': 0.225},
            {'min': 301, 'max': 350, 'rate': 0.21},
            {'min': 351, 'max': 400, 'rate': 0.17},
            {'min': 401, 'max': 450, 'rate': 0.145},
            {'min': 451, 'max': 500, 'rate': 0.12},
            {'min': 501, 'max': 550, 'rate': 0.105},
            {'min': 551, 'max': 600, 'rate': 0.09},
            {'min': 601, 'max': 650, 'rate': 0.075},
            {'min': 651, 'max': 700, 'rate': 0.055},
            {'min': 701, 'max': 750, 'rate': 0.045},
            {'min': 751, 'max': 800, 'rate': 0.04},
            {'min': 801, 'max': 850, 'rate': 0.025},
            {'min': 851, 'max': 900, 'rate': 0.01},
            {'min': 901, 'max': 1000, 'rate': 0.005}
        ];

        
        // This function is for EEI calculation for both ToU and General Tariff
        function calculate_eei_general(kwh) {
            if (kwh > 1000) return 0;
            for (let s of EEI_RATES_TOU) { // Reusing the same EEI_RATES_TOU as they are identical
                if (kwh >= s.min && kwh <= s.max) {
                    return +(kwh * s.rate).toFixed(2);
                }
            }
            return 0;
        }

        // Functions for Time-of-Use (ToU) Calculations
        function calculate_bill_from_usage_tou(total_usage, peak_percent) {
            const peak_usage = total_usage * (peak_percent / 100);
            const off_peak_usage = total_usage - peak_usage;

            const rates = total_usage <= 1500 ? TNB_RATES_TOU['low'] : TNB_RATES_TOU['high'];

            let non_taxable_kwh_limit = 600;

            let non_taxable_peak = Math.min(peak_usage, non_taxable_kwh_limit);
            let remaining_nt_limit = non_taxable_kwh_limit - non_taxable_peak;
            let non_taxable_off_peak = Math.min(off_peak_usage, remaining_nt_limit);
            
            let taxable_peak = peak_usage - non_taxable_peak;
            let taxable_off_peak = off_peak_usage - non_taxable_off_peak;

            let non_taxable_kwh = non_taxable_peak + non_taxable_off_peak;
            let taxable_kwh = taxable_peak + taxable_off_peak;

            // Using the unified EEI calculation function
            const eei_rebate = calculate_eei_general(total_usage);
            
            let eei_rebate_non_tax = 0.0;
            let eei_rebate_tax = 0.0;

            if (eei_rebate > 0 && total_usage > 0) {
                eei_rebate_non_tax = eei_rebate * (non_taxable_kwh / total_usage);
                eei_rebate_tax = eei_rebate * (taxable_kwh / total_usage);
            }

            // Charges - non-taxable part (<= 600kWh)
            const nt_energy_peak = non_taxable_peak * rates['peak'];
            const nt_energy_off_peak = non_taxable_off_peak * rates['off_peak'];
            const nt_capacity = non_taxable_kwh * rates['capacity'];
            const nt_network = non_taxable_kwh * rates['network'];
            const nt_retail = 0; // Retail waived if total <= 600

            const nt_subtotal = nt_energy_peak + nt_energy_off_peak + nt_capacity + nt_network + nt_retail - eei_rebate_non_tax;

            // Charges - taxable part (> 600kWh)
            const t_energy_peak = taxable_peak * rates['peak'];
            const t_energy_off_peak = taxable_off_peak * rates['off_peak'];
            const t_capacity = taxable_kwh * rates['capacity'];
            const t_network = taxable_kwh * rates['network'];
            const t_retail = total_usage > 600 ? rates['retail'] : 0;
            const t_subtotal = t_energy_peak + t_energy_off_peak + t_capacity + t_network + t_retail - eei_rebate_tax;

            const combined_subtotal = nt_subtotal + t_subtotal;

            const tax_base = t_subtotal;
            const service_tax = tax_base * 0.08;

            let kwtbb = 0.0;
            if (total_usage > 300) {
                const retail_for_kwtbb = total_usage > 600 ? t_retail : 0;
                kwtbb = (combined_subtotal - retail_for_kwtbb) * 0.016;
            }

            const total_bill = combined_subtotal + service_tax + kwtbb;

            return {
                'total_usage': parseFloat(total_usage.toFixed(2)),
                'peak_percent': parseFloat(peak_percent.toFixed(2)),
                'peak_usage_kwh': parseFloat(peak_usage.toFixed(2)),
                'off_peak_usage_kwh': parseFloat(off_peak_usage.toFixed(2)),
                'non_taxable_kwh': parseFloat(non_taxable_kwh.toFixed(2)),
                'taxable_kwh': parseFloat(taxable_kwh.toFixed(2)),
                'non_taxable_subtotal': parseFloat(nt_subtotal.toFixed(2)),
                'taxable_subtotal': parseFloat(t_subtotal.toFixed(2)),
                'energy_peak_total': parseFloat((nt_energy_peak + t_energy_peak).toFixed(2)),
                'energy_off_peak_total': parseFloat((nt_energy_off_peak + t_energy_off_peak).toFixed(2)),
                'capacity_total': parseFloat((nt_capacity + t_capacity).toFixed(2)),
                'network_total': parseFloat((nt_network + t_network).toFixed(2)),
                'retail_total': parseFloat(t_retail.toFixed(2)),
                'eei_rebate': parseFloat(eei_rebate.toFixed(2)),
                'subtotal_before_tax': parseFloat(combined_subtotal.toFixed(2)),
                'service_tax': parseFloat(service_tax.toFixed(2)),
                'kwtbb': parseFloat(kwtbb.toFixed(2)),
                'total_bill': parseFloat(total_bill.toFixed(2))
            };
        }

        function reverse_tnb_tou_bill(total_bill_input, peak_percent, tolerance = 0.01, max_kwh = 5000) {
            let low = 1.0;
            let high = max_kwh * 1.0;
            let guess = (low + high) / 2;

            let iterations = 0;
            const max_iterations = 100;

            let best_guess_kwh = null;
            let best_result_obj = null;
            let min_diff = Infinity;

            while (iterations < max_iterations) {
                const result = calculate_bill_from_usage_tou(guess, peak_percent);
                const calculated_bill = result['total_bill'];
                const difference = calculated_bill - total_bill_input;

                if (Math.abs(difference) < min_diff) {
                    min_diff = Math.abs(difference);
                    best_guess_kwh = guess;
                    best_result_obj = result;
                }

                if (Math.abs(difference) <= tolerance) {
                    return {
                        'estimated_total_kwh': parseFloat(guess.toFixed(2)),
                        'estimated_peak_kwh': parseFloat(result['peak_usage_kwh'].toFixed(2)),
                        'estimated_off_peak_kwh': parseFloat(result['off_peak_usage_kwh'].toFixed(2)),
                        'peak_percent': parseFloat(peak_percent.toFixed(2)),
                        'off_peak_percent': parseFloat((100 - peak_percent).toFixed(2)),
                        'matched_total_bill': parseFloat(calculated_bill.toFixed(2)),
                        'service_tax': result['service_tax'],
                        'kwtbb': result['kwtbb'],
                        'retail_total': result['retail_total'], // Corrected key to match calculate_bill_from_usage_tou
                        'network_total': result['network_total'], // Corrected key
                        'capacity_total': result['capacity_total'], // Corrected key
                        'energy_peak_total': result['energy_peak_total'],
                        'energy_off_peak_total': result['energy_off_peak_total'],
                        'eei_rebate': result['eei_rebate'],
                        'subtotal_before_tax': result['subtotal_before_tax'],
                        'iterations': iterations,
                        'status': 'matched_within_tolerance'
                    };
                }

                if (calculated_bill < total_bill_input) {
                    low = guess;
                } else {
                    high = guess;
                }

                guess = (low + high) / 2;
                iterations += 1;
            }

            // Fine-tune scan ±2 kWh
            for (let i = -20; i <= 20; i++) {
                const adj = i / 10.0;
                const refined_kwh = best_guess_kwh + adj;
                if (refined_kwh < 0) {
                    continue;
                }
                const result = calculate_bill_from_usage_tou(refined_kwh, peak_percent);
                const calculated_bill = result['total_bill'];
                const diff = Math.abs(calculated_bill - total_bill_input);
                if (diff <= tolerance) {
                    return {
                        'estimated_total_kwh': parseFloat(refined_kwh.toFixed(2)),
                        'estimated_peak_kwh': parseFloat(result['peak_usage_kwh'].toFixed(2)),
                        'estimated_off_peak_kwh': parseFloat(result['off_peak_usage_kwh'].toFixed(2)),
                        'peak_percent': parseFloat(peak_percent.toFixed(2)),
                        'off_peak_percent': parseFloat((100 - peak_percent).toFixed(2)),
                        'matched_total_bill': parseFloat(calculated_bill.toFixed(2)),
                        'service_tax': result['service_tax'],
                        'kwtbb': result['kwtbb'],
                        'retail_total': result['retail_total'],
                        'network_total': result['network_total'],
                        'capacity_total': result['capacity_total'],
                        'energy_peak_total': result['energy_peak_total'],
                        'energy_off_peak_total': result['energy_off_peak_total'],
                        'eei_rebate': result['eei_rebate'],
                        'subtotal_before_tax': result['subtotal_before_tax'],
                        'iterations': iterations,
                        'status': 'matched_in_fine_scan'
                    };
                }
            }

            // Final fallback: return best guess even if not matched
            const best_kwh = parseFloat(best_guess_kwh.toFixed(2));
            const best_result = best_result_obj;
            const best_peak_kwh = parseFloat((best_kwh * (peak_percent / 100)).toFixed(2));
            const best_off_peak_kwh = parseFloat((best_kwh - best_peak_kwh).toFixed(2));

            return {
                'error': 'No exact match found within tolerance, returning best estimate.',
                'estimated_total_kwh': best_kwh, // Changed from best_guess_kwh to align with other fields
                'estimated_peak_kwh': best_peak_kwh,
                'estimated_off_peak_kwh': best_off_peak_kwh,
                'peak_percent': parseFloat(peak_percent.toFixed(2)),
                'off_peak_percent': parseFloat((100 - peak_percent).toFixed(2)),
                'matched_total_bill': parseFloat(best_result['total_bill'].toFixed(2)), // Consistent naming
                'service_tax': best_result['service_tax'],
                'kwtbb': best_result['kwtbb'],
                'retail_total': best_result['retail_total'], // Corrected key to match calculate_bill_from_usage_tou
                'network_total': best_result['network_total'], // Corrected key
                'capacity_total': best_result['capacity_total'], // Corrected key
                'energy_peak_total': best_result['energy_peak_total'],
                'energy_off_peak_total': best_result['energy_off_peak_total'],
                'eei_rebate': best_result['eei_rebate'],
                'subtotal_before_tax': best_result['subtotal_before_tax'],
                'difference': parseFloat(min_diff.toFixed(2)), // Use min_diff for accuracy
                'iterations': iterations,
                'status': 'best_estimate_only'
            };
        }


        function calculateBillTou() {
            const totalUsage = parseFloat(document.getElementById('totalUsage').value);
            const peakPercent = parseFloat(document.getElementById('peakPercent').value);
            const errorDiv = document.getElementById('calculateBillError');
            const outputDiv = document.getElementById('billOutput');

            errorDiv.textContent = '';
            outputDiv.classList.add('hidden'); // Hide output by default

            console.log("calculateBillTou called.");
            console.log("Input - Total Usage:", totalUsage, "Peak Percent:", peakPercent);

            if (isNaN(totalUsage) || totalUsage < 0) {
                errorDiv.textContent = 'Please enter a valid positive number for Total Usage.';
                console.error("Validation error: Invalid Total Usage.");
                return;
            }
            if (isNaN(peakPercent) || peakPercent < 0 || peakPercent > 100) {
                errorDiv.textContent = 'Please enter a valid percentage (0-100) for Peak Usage Percentage.';
                console.error("Validation error: Invalid Peak Usage Percentage.");
                return;
            }

            // Added check for 0 usage, as EEI calculation might result in NaN for 0/0
            if (totalUsage === 0) {
                errorDiv.textContent = 'Total Usage cannot be zero for a bill calculation.';
                console.error("Validation error: Total Usage is zero.");
                return;
            }


            const result = calculate_bill_from_usage_tou(totalUsage, peakPercent);
            console.log("Calculation Result:", result);

            document.getElementById('outputTotalUsage').textContent = result.total_usage.toFixed(2) + ' kWh';
            document.getElementById('outputPeakUsageKWH').textContent = result.peak_usage_kwh.toFixed(2) + ' kWh';
            document.getElementById('outputOffPeakUsageKWH').textContent = result.off_peak_usage_kwh.toFixed(2) + ' kWh';
            document.getElementById('outputPeakPercent').textContent = result.peak_percent.toFixed(2) + '%';
            document.getElementById('outputOffPeakPercent').textContent = (100 - result.peak_percent).toFixed(2) + '%';
            document.getElementById('outputEnergyPeakTotal').textContent = 'RM ' + result.energy_peak_total.toFixed(2);
            document.getElementById('outputEnergyOffPeakTotal').textContent = 'RM ' + result.energy_off_peak_total.toFixed(2);
            document.getElementById('outputCapacityTotal').textContent = 'RM ' + result.capacity_total.toFixed(2);
            document.getElementById('outputNetworkTotal').textContent = 'RM ' + result.network_total.toFixed(2);
            document.getElementById('outputRetailTotal').textContent = 'RM ' + result.retail_total.toFixed(2);
            document.getElementById('outputEEIRebate').textContent = '- RM ' + result.eei_rebate.toFixed(2);
            document.getElementById('outputSubtotalBeforeTax').textContent = 'RM ' + result.subtotal_before_tax.toFixed(2);
            document.getElementById('outputServiceTax').textContent = 'RM ' + result.service_tax.toFixed(2);
            document.getElementById('outputKWTBB').textContent = 'RM ' + result.kwtbb.toFixed(2);
            document.getElementById('outputTotalBill').textContent = 'RM ' + result.total_bill.toFixed(2);

            outputDiv.classList.remove('hidden'); // Show output
            console.log("Output section should now be visible.");
        }

        function estimateUsageTou() {
            const targetBill = parseFloat(document.getElementById('targetBill').value);
            const peakPercentReverse = parseFloat(document.getElementById('peakPercentReverse').value);
            const errorDiv = document.getElementById('estimateUsageError');
            const outputDiv = document.getElementById('usageOutput');

            errorDiv.textContent = '';
            outputDiv.classList.add('hidden'); // Hide output by default

            if (isNaN(targetBill) || targetBill < 0) {
                errorDiv.textContent = 'Please enter a valid positive number for Target Total Bill.';
                return;
            }
            if (isNaN(peakPercentReverse) || peakPercentReverse < 0 || peakPercentReverse > 100) {
                errorDiv.textContent = 'Please enter a valid percentage (0-100) for Peak Usage Percentage.';
                return;
            }

            const result = reverse_tnb_tou_bill(targetBill, peakPercentReverse);

            let displayResult = result;
            let billToDisplay = result.matched_total_bill;

            if (result.error) {
                errorDiv.textContent = result.error + ' The closest estimate is shown.';
                billToDisplay = result.matched_total_bill + ' (Difference: RM ' + result.difference.toFixed(2) + ')';
            }
            
            document.getElementById('outputEstimatedTotalKWH').textContent = displayResult.estimated_total_kwh + ' kWh';
            document.getElementById('outputEstimatedPeakKWH').textContent = displayResult.estimated_peak_kwh.toFixed(2) + ' kWh';
            document.getElementById('outputEstimatedOffPeakKWH').textContent = displayResult.estimated_off_peak_kwh.toFixed(2) + ' kWh';
            document.getElementById('outputReversePeakPercent').textContent = displayResult.peak_percent.toFixed(2) + '%';
            document.getElementById('outputReverseOffPeakPercent').textContent = displayResult.off_peak_percent.toFixed(2) + '%';
            document.getElementById('outputMatchedTotalBill').textContent = 'RM ' + billToDisplay;
            
            document.getElementById('outputReverseServiceTax').textContent = 'RM ' + displayResult.service_tax.toFixed(2);
            document.getElementById('outputReverseKWTBB').textContent = 'RM ' + displayResult.kwtbb.toFixed(2);
            document.getElementById('outputReverseRetailCharge').textContent = 'RM ' + displayResult.retail_total.toFixed(2);
            document.getElementById('outputReverseNetworkCharge').textContent = 'RM ' + displayResult.network_total.toFixed(2);
            document.getElementById('outputReverseCapacityCharge').textContent = 'RM ' + displayResult.capacity_total.toFixed(2);
            document.getElementById('outputReverseEnergyPeakTotal').textContent = 'RM ' + displayResult.energy_peak_total.toFixed(2);
            document.getElementById('outputReverseEnergyOffPeakTotal').textContent = 'RM ' + displayResult.energy_off_peak_total.toFixed(2);
            document.getElementById('outputReverseEEIRebate').textContent = '- RM ' + displayResult.eei_rebate.toFixed(2);
            document.getElementById('outputReverseSubtotalBeforeTax').textContent = 'RM ' + displayResult.subtotal_before_tax.toFixed(2);
            document.getElementById('outputReverseStatus').textContent = 'Status: ' + (displayResult.status ? displayResult.status.replace(/_/g, ' ') : 'N/A') + ' (Iterations: ' + displayResult.iterations + ')';


            outputDiv.classList.remove('hidden'); // Show output
        }

        // Functions for Domestic General Tariff Calculations
        function calculate_bill_from_usage_general(kwh) {
            const rates = kwh <= 1500 ? TNB_RATES_GENERAL.low : TNB_RATES_GENERAL.high;

            const nonTaxKwh = Math.min(kwh, 600);
            const taxKwh = Math.max(0, kwh - 600);
            const eei = calculate_eei_general(kwh); // Using the unified EEI calculation function

            let eeiNonTax = (eei > 0 && kwh > 0) ? eei * (nonTaxKwh / kwh) : 0;
            let eeiTax = (eei > 0 && kwh > 0) ? eei * (taxKwh / kwh) : 0;

            const ntEnergy = nonTaxKwh * rates.energy;
            const ntCapacity = nonTaxKwh * rates.capacity;
            const ntNetwork = nonTaxKwh * rates.network;
            const ntSubtotal = ntEnergy + ntCapacity + ntNetwork - eeiNonTax;

            const tEnergy = taxKwh * rates.energy;
            const tCapacity = taxKwh * rates.capacity;
            const tNetwork = taxKwh * rates.network;
            const tRetail = kwh > 600 ? rates.retail : 0;
            const tSubtotal = tEnergy + tCapacity + tNetwork + tRetail - eeiTax;

            const combinedSubtotal = ntSubtotal + tSubtotal;
            const serviceTax = tSubtotal * 0.08;
            const kwtbb = (kwh > 300 ? (combinedSubtotal - tRetail) * 0.016 : 0);

            const total = combinedSubtotal + serviceTax + kwtbb;

            return {
                kwh: parseFloat(kwh.toFixed(2)),
                total: parseFloat(total.toFixed(2)),
                subtotal: parseFloat(combinedSubtotal.toFixed(2)),
                serviceTax: parseFloat(serviceTax.toFixed(2)),
                kwtbb: parseFloat(kwtbb.toFixed(2)),
                eei: parseFloat(eei.toFixed(2)),
                breakdown: {
                    energyNT: parseFloat(ntEnergy.toFixed(2)),
                    energyTax: parseFloat(tEnergy.toFixed(2)),
                    capacity: parseFloat((ntCapacity + tCapacity).toFixed(2)),
                    network: parseFloat((ntNetwork + tNetwork).toFixed(2)),
                    retail: parseFloat(tRetail.toFixed(2))
                }
            };
        }

        function reverse_tnb_bill_general(targetBill) {
            let low = 1, high = 5000, mid;
            let bestDiff = Infinity;
            let bestResult = null;
            let iterations = 0;
            const max_iterations = 100;
            const tolerance = 0.01;

            while (iterations < max_iterations) {
                mid = (low + high) / 2;
                const res = calculate_bill_from_usage_general(mid);
                const diff = Math.abs(res.total - targetBill);

                if (diff < bestDiff) {
                    bestDiff = diff;
                    bestResult = res;
                }

                if (diff <= tolerance) {
                    return { ...res, iterations: iterations, status: 'matched_within_tolerance' };
                }
                if (res.total < targetBill) low = mid;
                else high = mid;
                iterations++;
            }

            // Fine-tune scan ±2 kWh
            for (let i = -20; i <= 20; i++) {
                const adj = i / 10.0;
                const refined_kwh = bestResult.kwh + adj;
                if (refined_kwh < 0) {
                    continue;
                }
                const result = calculate_bill_from_usage_general(refined_kwh);
                const diff = Math.abs(result.total - targetBill);
                if (diff <= tolerance) {
                    return { ...result, iterations: iterations, status: 'matched_in_fine_scan' };
                }
            }

            // Fallback: return best guess if no match within tolerance after iterations
            return {
                error: 'No exact match found within tolerance, returning best estimate.',
                kwh: parseFloat(bestResult.kwh.toFixed(2)),
                total: parseFloat(bestResult.total.toFixed(2)),
                subtotal: parseFloat(bestResult.subtotal.toFixed(2)),
                serviceTax: parseFloat(bestResult.serviceTax.toFixed(2)),
                kwtbb: parseFloat(bestResult.kwtbb.toFixed(2)),
                eei: parseFloat(bestResult.eei.toFixed(2)),
                breakdown: bestResult.breakdown,
                difference: parseFloat(bestDiff.toFixed(2)),
                iterations: iterations,
                status: 'best_estimate_only'
            };
        }

        function calculateGeneralBill() {
            const totalUsage = parseFloat(document.getElementById("generalUsageInput").value);
            const errorDiv = document.getElementById('generalCalculateBillError');
            const outputDiv = document.getElementById('generalBillOutput');

            errorDiv.textContent = '';
            outputDiv.classList.add('hidden');

            if (isNaN(totalUsage) || totalUsage < 0) {
                errorDiv.textContent = 'Please enter a valid positive number for Total Usage.';
                return;
            }

            const result = calculate_bill_from_usage_general(totalUsage);
            
            document.getElementById('generalOutputTotalUsage').textContent = result.kwh.toFixed(2) + ' kWh';
            document.getElementById('generalOutputEnergyNT').textContent = 'RM ' + result.breakdown.energyNT.toFixed(2);
            document.getElementById('generalOutputEnergyTax').textContent = 'RM ' + result.breakdown.energyTax.toFixed(2);
            document.getElementById('generalOutputCapacity').textContent = 'RM ' + result.breakdown.capacity.toFixed(2);
            document.getElementById('generalOutputNetwork').textContent = 'RM ' + result.breakdown.network.toFixed(2);
            document.getElementById('generalOutputRetail').textContent = 'RM ' + result.breakdown.retail.toFixed(2);
            document.getElementById('generalOutputEEI').textContent = '- RM ' + result.eei.toFixed(2);
            document.getElementById('generalOutputSubtotal').textContent = 'RM ' + result.subtotal.toFixed(2);
            document.getElementById('generalOutputServiceTax').textContent = 'RM ' + result.serviceTax.toFixed(2);
            document.getElementById('generalOutputKWTBB').textContent = 'RM ' + result.kwtbb.toFixed(2);
            document.getElementById('generalOutputTotalBill').textContent = 'RM ' + result.total.toFixed(2);

            outputDiv.classList.remove('hidden');
        }

        function estimateGeneralUsage() {
            const targetBill = parseFloat(document.getElementById("generalBillInput").value);
            const errorDiv = document.getElementById('generalEstimateUsageError');
            const outputDiv = document.getElementById('generalUsageOutput');

            errorDiv.textContent = '';
            outputDiv.classList.add('hidden');

            if (isNaN(targetBill) || targetBill < 0) {
                errorDiv.textContent = 'Please enter a valid positive number for Target Total Bill.';
                return;
            }

            const result = reverse_tnb_bill_general(targetBill);

            if (result.error) {
                errorDiv.textContent = result.error + ' The closest estimate is shown.';
                document.getElementById('generalOutputEstimatedTotalKWH').textContent = result.kwh.toFixed(2) + ' kWh';
                document.getElementById('generalOutputMatchedTotalBill').textContent = 'RM ' + result.total.toFixed(2) + ' (Difference: RM ' + result.difference.toFixed(2) + ')';
            } else {
                document.getElementById('generalOutputEstimatedTotalKWH').textContent = result.kwh.toFixed(2) + ' kWh';
                document.getElementById('generalOutputMatchedTotalBill').textContent = 'RM ' + result.total.toFixed(2);
            }

            document.getElementById('generalReverseEnergyNT').textContent = 'RM ' + result.breakdown.energyNT.toFixed(2);
            document.getElementById('generalReverseEnergyTax').textContent = 'RM ' + result.breakdown.energyTax.toFixed(2);
            document.getElementById('generalReverseCapacity').textContent = 'RM ' + result.breakdown.capacity.toFixed(2);
            document.getElementById('generalReverseNetwork').textContent = 'RM ' + result.breakdown.network.toFixed(2);
            document.getElementById('generalReverseRetail').textContent = 'RM ' + result.breakdown.retail.toFixed(2);
            document.getElementById('generalReverseEEI').textContent = '- RM ' + result.eei.toFixed(2);
            document.getElementById('generalReverseSubtotal').textContent = 'RM ' + result.subtotal.toFixed(2);
            document.getElementById('generalReverseServiceTax').textContent = 'RM ' + result.serviceTax.toFixed(2);
            document.getElementById('generalReverseKWTBB').textContent = 'RM ' + result.kwtbb.toFixed(2);
            document.getElementById('generalReverseStatus').textContent = 'Status: ' + (result.status ? result.status.replace(/_/g, ' ') : 'N/A') + ' (Iterations: ' + result.iterations + ')';

            outputDiv.classList.remove('hidden');
        }


        // Function to toggle sections based on select list
        function toggleSections() {
            const calculationType = document.getElementById('calculationType').value;
            
            // ToU sections
            const calculateBillSectionToU = document.getElementById('calculateBillSection');
            const estimateUsageSectionToU = document.getElementById('estimateUsageSection');
            const billOutputToU = document.getElementById('billOutput');
            const usageOutputToU = document.getElementById('usageOutput');
            const calculateBillErrorToU = document.getElementById('calculateBillError');
            const estimateUsageErrorToU = document.getElementById('estimateUsageError');

            // General Tariff sections
            const generalTariffCalculateBillSection = document.getElementById('generalTariffCalculateBillSection');
            const generalTariffEstimateUsageSection = document.getElementById('generalTariffEstimateUsageSection');
            const generalBillOutput = document.getElementById('generalBillOutput');
            const generalUsageOutput = document.getElementById('generalUsageOutput');
            const generalCalculateBillError = document.getElementById('generalCalculateBillError');
            const generalEstimateUsageError = document.getElementById('generalEstimateUsageError');

            // Hide all sections and clear errors first
            calculateBillSectionToU.classList.add('hidden');
            estimateUsageSectionToU.classList.add('hidden');
            billOutputToU.classList.add('hidden');
            usageOutputToU.classList.add('hidden');
            calculateBillErrorToU.textContent = '';
            estimateUsageErrorToU.textContent = '';

            generalTariffCalculateBillSection.classList.add('hidden');
            generalTariffEstimateUsageSection.classList.add('hidden');
            generalBillOutput.classList.add('hidden');
            generalUsageOutput.classList.add('hidden');
            generalCalculateBillError.textContent = '';
            generalEstimateUsageError.textContent = '';

            if (calculationType === 'calculate_bill_tou') {
                calculateBillSectionToU.classList.remove('hidden');
            } else if (calculationType === 'estimate_usage_tou') {
                estimateUsageSectionToU.classList.remove('hidden');
            } else if (calculationType === 'calculate_bill_general') {
                generalTariffCalculateBillSection.classList.remove('hidden');
            } else if (calculationType === 'estimate_usage_general') {
                generalTariffEstimateUsageSection.classList.remove('hidden');
            }
        }

        // Initialize the view when the page loads
        document.addEventListener('DOMContentLoaded', toggleSections);

    </script>
</body>
</html>